<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1519394255615630"
     crossorigin="anonymous"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ノートの切れ端</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
    <script type="module" src="main.js"></script>
</head>
<body>
    <div id="debug-panel">ID:<span id="debug-my-id"></span></div>
    <div id="name-tag"></div>

    <div id="detail-modal" onclick="if(event.target===this) closeDetailModal()">
        <div class="detail-card">
            <button onclick="closeDetailModal()" style="position:absolute; top:5px; right:5px; z-index:10; background:rgba(0,0,0,0.5); color:#fff; border:none; border-radius:50%; width:24px; height:24px;">×</button>
            <div class="detail-image-box">
                <img id="detail-img" src="">
                <div id="detail-fusen-layer"></div>
            </div>
            <div id="detail-actions" style="margin-top:10px; text-align:center;">
                <p style="font-size:12px; margin:0 0 5px 0; color:#006940; font-weight:bold;">🖌️ この絵にシールを貼る！</p>
                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
                    <button onclick="sendFusen('smile')" class="fusen-btn">😊 にっこり</button>
                    <button onclick="sendFusen('good')" class="fusen-btn">👍 いいね</button>
                    <button onclick="sendFusen('clap')" class="fusen-btn">👏 パチパチ</button>
                </div>
                <div id="detail-coloring-btn-container"></div>
            </div>
        </div>
    </div>

    <div id="reference-modal" onclick="if(event.target===this) closeReferenceModal()"><img id="ref-modal-img" src=""><button onclick="closeReferenceModal()">閉じる</button></div>
    
    <div id="howto-modal" onclick="if(event.target===this) closeHowTo()">
        <div class="howto-content">
            <h2 style="border-bottom:2px solid #009688; color:#009688;">📖 遊び方</h2>
            <p><strong>1. 部屋を作る</strong><br>好きな「クラス名」を決めて部屋を作ります。合言葉は自動で鍵がかかります。</p>
            <p><strong>2. 招待する</strong><br>「招待状コピー」ボタンを押して、URLを友達に送ります。URLを押すだけで合流できます。</p>
            <p><strong>3. 描く</strong><br>自分の番が来たらキャンバスに絵を描いて「回す」ボタンを押すだけ！</p>
            <p><strong>4. 見る・応援する</strong><br>ギャラリーの絵をタップすると、完成した絵にシール（付箋）を貼って応援できます。</p>
            <p style="text-align:center; margin-top:20px;"><button onclick="closeHowTo()" class="title-menu-btn btn-create" style="width:auto; font-size:14px; padding:10px 30px;">閉じる</button></p>
        </div>
    </div>

    <div id="cm-overlay"><h2>CM再生中...</h2><p>（3秒お待ちください）</p><div style="font-size: 30px; margin-top: 20px;">📺</div></div>

    <div id="screen-title" class="screen active" style="display:flex; text-align:center;">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <h1 class="title-logo">ノートの切れ端</h1>
            
            <div id="joined-rooms-container" style="display:none; width: 90%; max-width: 300px; margin: 0 auto 15px auto; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 10px;">
                <p style="color:#fff; font-size:14px; margin:0 0 10px 0; font-weight:bold; text-align:left;">👞 参加中の教室</p>
                <div id="joined-rooms-list" style="display:flex; flex-direction:column; gap:8px;"></div>
            </div>

            <button onclick="goToLobby()" class="title-menu-btn btn-create" style="margin-top:0;">🏫 新しい教室を作る</button>
            <div style="margin-top:15px;">
                <button onclick="showHowTo()" class="btn-howto">📖 遊び方を見る</button>
            </div>
        </div>
        <div class="version-tag">v24.1</div>
    </div>

    <div id="screen-getabako" class="screen">
        <div style="text-align:center; padding-top:40px; color:#fff;">
            <h1 style="margin:0; font-size:36px; border-bottom:4px solid #fdd835; display:inline-block; padding:0 10px;">ノートの切れ端</h1>
            <div style="background:#fff; margin:20px; padding:30px; border-radius:10px; color:#333; box-shadow:3px 3px 0 rgba(0,0,0,0.2);">
                <div style="font-size:40px; margin-bottom:10px;">💌</div>
                <p id="getabako-msg" style="font-size:16px; margin-bottom:10px;">...</p>
                <input type="text" id="getabako-name" placeholder="あなたのお名前" style="text-align:center; background:#eee;">
                <button id="btn-getabako-continue" class="action-btn">👟 入室する</button>
                <button id="btn-getabako-ignore" class="action-btn" style="background:#009688; border:1px solid #00796b; margin-top:15px; display:none;">👟 招待を破棄して戻る</button>
            </div>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div style="text-align:center; padding-top:20px; color:#fff;">
            <button onclick="window.showScreen('screen-title')" style="background:transparent; border:1px solid rgba(255,255,255,0.5); color:#fff; border-radius:20px; padding:5px 15px; margin-bottom:10px;">↩ タイトルに戻る</button>
        </div>
        <div class="lobby-card" id="create-section">
            <h3>教室を作る</h3>
            <input type="text" id="new-room-name" placeholder="クラス名（例: 2-C）">
            <input type="text" id="new-host-name" placeholder="あなたの名前">
            <button onclick="createRoom()" class="action-btn">ノートを開く</button>
            <p style="font-size:10px; color:#888; margin-top:10px;">※合言葉は自動で作成され、安全に鍵がかかります。</p>
        </div>
        <div style="text-align:center; margin-top:20px;"><button onclick="resetIdentity()" style="background:rgba(255,255,255,0.2); border:1px solid #fff; color:#fff; padding:5px 10px; border-radius:15px; font-size:10px;">⚠️ 全データリセット（引退）</button></div>
    </div>
    
    <div id="screen-waiting" class="screen">
        <div class="ad-space">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-1519394255615630"
                 data-ad-slot="5159622327"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>
        <div class="notebook-header">
            <div style="position:relative; display:flex; justify-content:center; align-items:center; margin-bottom:5px;">
                <button onclick="returnToTitle()" style="position:absolute; left:0; background:rgba(255,255,255,0.2); border:1px solid #fff; color:#fff; border-radius:4px; padding:2px 8px; font-size:12px; cursor:pointer;">👞 戻る</button>
                <div class="header-title-box" style="margin-bottom:0;"><span class="room-name-label"></span></div>
            </div>
            
            <ul id="member-list"></ul>
            <div id="header-sub-msg" style="font-size:12px;"></div>
            <div class="timer-pencil-container" style="margin-top:10px;"><div class="timer-bar-fill"></div></div>
            <button id="btn-disband" onclick="disbandRoom()" style="margin-top:10px; background:#d32f2f; border:1px solid #b71c1c; color:#fff; padding:5px 15px; border-radius:20px; font-size:12px; cursor:pointer; display:none; width:100%;">💣 教室を解散する</button>

            <button id="reset-room-btn" onclick="resetRoomHistory()" style="margin-top:5px; background:#ef5350; border:1px solid #fff; color:#fff; border-radius:10px; font-size:10px; padding:5px 10px; cursor:pointer; display:none;">🧹 黒板消し（履歴リセット）</button>
            <button onclick="leaveRoom()" style="margin-top:5px; background:transparent; border:1px solid #fff; color:#fff; border-radius:4px; font-size:10px; padding:2px 5px;">🏫 転校する（退出）</button>
        </div>
        <div class="waiting-msg"><div id="turn-indicator">あなたの番！</div><button id="continue-btn" onclick="resumeDrawing()" ontouchstart="resumeDrawing()" class="action-btn" style="width:auto; padding:10px 30px; display:none; margin:10px auto;">✏️ 続けて描く</button></div>
        <div style="padding:10px; font-size:12px; display:flex; justify-content:space-between; align-items:end;"><span style="background:rgba(255,255,255,0.8); padding:2px 5px; border-radius:4px;">これまでの落書き (<span id="history-count">0</span>)</span><button onclick="copyInvite()" class="secondary-btn">🔗 招待状コピー</button></div>
        <input type="text" class="invite-url-box" readonly onclick="this.select()">
        <div id="gallery" class="gallery-scroll"></div>
    </div>
    
    <div id="screen-game" class="screen">
        <div class="ad-space">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-1519394255615630"
                 data-ad-slot="5159622327"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>
        
        <div class="notebook-header" style="padding:5px; margin:5px; display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:5px;">
                <button onclick="returnToTitle()" style="background:rgba(255,255,255,0.2); border:1px solid #fff; color:#fff; border-radius:4px; font-size:10px; padding: 2px 5px; cursor:pointer;">👞戻る</button>
                <span class="room-name-label" style="font-size:18px;"></span>
                <button onclick="copyInvite()" style="background:rgba(255,255,255,0.2); border:1px solid #fff; color:#fff; border-radius:4px; font-size:10px; padding: 2px 5px;">🔗招待</button>
            </div>
            <div id="timer-pencil-container" class="timer-pencil-container" style="max-width:100px; margin: 0 5px;"><div class="timer-bar-fill"></div></div>
            <div style="display:flex; gap:5px;">
                <button id="btn-game-disband" onclick="disbandRoom()" style="background:#d32f2f; border:1px solid #b71c1c; color:#fff; border-radius:4px; font-size:10px; display:none;">💣解散</button>
            </div>
        </div>

        <div class="canvas-area" id="canvas-area">
            <div class="notebook-paper">
                <div id="prev-history-container"><div id="prev-history-bar" style="display:flex; gap:5px;"></div></div>
                <div id="prev-img-container" style="display:none;"><span style="font-size:10px; color:#666;">前の絵</span><img id="prev-img" src=""></div>
                <canvas id="canvas"></canvas>
            </div>
        </div>
        <div class="bottom-toolbar"><div class="tool-group"><button id="btn-thin" class="tool-btn selected" onclick="setPen('thin')">細</button><button id="btn-thick" class="tool-btn" onclick="setPen('thick')">太</button><button id="btn-eraser" class="tool-btn" onclick="setPen('eraser')">消</button></div><button onclick="submitArt()" class="submit-btn">次の人へ回す</button></div>
    </div>
    
    <div id="screen-graduation" class="screen">
        <div class="notebook-header">
            <div style="position:relative; display:flex; justify-content:center; align-items:center; margin-bottom:5px;">
                <button onclick="returnToTitle()" style="position:absolute; left:0; background:rgba(255,255,255,0.2); border:1px solid #fff; color:#fff; border-radius:4px; padding:2px 8px; font-size:12px; cursor:pointer;">👞 戻る</button>
                <div class="header-title-box" style="margin-bottom:0;">🎓 卒業制作</div>
            </div>
            <div style="font-size:12px; margin-top:5px;">好きな絵を塗って持って帰ろう！</div>
            <div style="font-size:12px; color:#fff176;">残りチケット: <span id="coloring-ticket-count">1</span>枚</div>
            <button onclick="leaveRoom()" style="margin-top:10px; background:transparent; border:1px solid #fff; color:#fff; border-radius:4px; font-size:10px; padding:2px 5px;">🏫 転校する（退出）</button>
        </div>
        <div id="grad-grid"></div>
        <div style="padding: 20px; text-align: center;"><div id="host-delete-area" style="display:none; margin-top:20px; padding-top:20px; border-top:1px solid rgba(0,0,0,0.1);"><p style="font-size:12px; color:#d32f2f;">※日直専用</p><button onclick="deleteRoomData()" style="background:#d32f2f; color:#fff; border:none; padding:10px 20px; border-radius:4px;">🗑 教室を片付ける（全削除）</button></div></div>
    </div>
    
    <div id="screen-coloring" class="screen">
        <div class="notebook-header" style="padding:5px; display:flex; justify-content:space-between; align-items:center;"><span>🎨 塗り絵モード</span><button onclick="closeColoring()" style="background:transparent; border:1px solid #fff; color:#fff; border-radius:4px; font-size:10px;">戻る</button></div>
        <div id="coloring-container"><canvas id="coloring-canvas"></canvas><img id="line-art-overlay" src=""></div>
        <div class="bottom-toolbar coloring-toolbar">
            <div class="tool-row"><input type="color" id="color-picker" value="#ffeb3b" onchange="updateColor()" style="width:40px; height:40px; padding:0; border:none; border-radius:50%; overflow:hidden;"><div style="display:flex; flex-direction:column; align-items:center;"><span class="size-label">太さ</span><input type="range" id="pen-size-slider" min="1" max="50" step="1" oninput="updateSize()"></div></div>
            <div class="tool-row"><div id="tool-marker" class="tool-box selected" onclick="setMarker('marker')"><div class="pencil-icon"></div></div><div id="tool-crayon" class="tool-box" onclick="setMarker('crayon')"><div class="pencil-icon"></div></div><div id="tool-eraser" class="tool-box" onclick="setMarker('eraser')"><div class="eraser-icon"></div></div><button onclick="saveColoring()" class="submit-btn" style="width:auto; margin-left:10px; background:#03a9f4; box-shadow:0 3px 0 #0277bd;">完成!</button></div>
        </div>
    </div>
</body>
</html>
